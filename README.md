# CIMC 工业嵌入式系统

基于 GD32F4 的工业电压采集与监控系统，支持实时数据采集、显示、告警、配置管理和数据持久化。

## 系统概述

本项目实现了一个完整的工业嵌入式数据采集系统，具备以下核心能力：
- 多通道电压数据采集（ADC + DMA）
- OLED 实时显示与 LED 状态指示
- 串口命令交互与参数配置
- TF 卡文件系统数据存储
- 外部 Flash 参数持久化
- 数据加密编码与解码

## 硬件架构

**主控制器**: GD32F470 系列微控制器

**外设模块**:
- ADC: 电压信号采集
- OLED: 128x32 I2C 显示屏
- TF 卡: SDIO 接口数据存储
- SPI Flash: 外部存储器（如 GD25Qxx）
- RTC: 实时时钟模块
- 按键: KEY1-KEY4 用户输入
- LED: LED1/LED2 状态指示

## 软件架构

```
├── 应用层 (main.c)
│   ├── 系统初始化
│   ├── 外设配置
│   └── 主循环调度
├── 功能模块层 (sysFunction/)
│   ├── sampling_control  # 采样控制
│   ├── data_storage      # 数据存储
│   ├── config_manager    # 配置管理
│   ├── device_id         # 设备标识
│   └── scheduler         # 任务调度
├── 驱动层
│   ├── adc_app, led_app, oled_app
│   ├── flash_app, rtc_app, key_app
│   └── HAL 外设驱动
└── 中间件
    ├── FatFs 文件系统
    ├── LittleFS 文件系统
    └── RT-Thread 组件
```

## 主要功能

### 1. 系统管理
- **自检功能**: 检测 Flash、TF 卡等外设状态
- **时间管理**: RTC 时间设置与查询
- **设备标识**: 唯一设备 ID 管理

### 2. 数据采集
- **采样控制**: 支持 5s/10s/15s 可配置周期
- **多种启停方式**: 串口命令或按键控制
- **实时显示**: OLED 显示时间和电压值
- **状态指示**: LED1 采样状态，LED2 告警指示

### 3. 参数配置
- **变比设置**: 0-100 范围的浮点数配置
- **阈值设置**: 0-500 范围的告警阈值
- **配置文件**: 支持从 TF 卡读取 config.ini
- **参数持久化**: 外部 Flash 存储，掉电保持

### 4. 数据存储
文件存储在 TF 卡的不同目录下：
- `sample/`: 常规采样数据
- `overLimit/`: 超阈值告警数据  
- `log/`: 系统操作日志
- `hideData/`: 加密编码数据

### 5. 数据编码
支持将时间戳和电压值编码为 HEX 格式：
- **时间戳**: 4字节 Unix 时间戳
- **电压值**: 4字节（整数部分2字节 + 小数部分2字节）

## 串口命令

| 命令 | 功能描述 |
|------|----------|
| `test` | 系统自检 |
| `RTC Config` | 设置 RTC 时间 |
| `RTC now` | 查询当前时间 |
| `conf` | 读取配置文件 |
| `ratio` | 设置变比参数 |
| `limit` | 设置告警阈值 |
| `config save` | 保存参数到 Flash |
| `config read` | 从 Flash 读取参数 |
| `start` / `stop` | 启动/停止采样 |
| `hide` / `unhide` | 启用/禁用数据编码 |

## 按键操作

- **KEY1**: 采样启停切换
- **KEY2**: 设置采样周期为 5s
- **KEY3**: 设置采样周期为 10s  
- **KEY4**: 设置采样周期为 15s

## 目录结构

```
CIMC_Project/
├── Core/                   # STM32 核心文件
│   ├── Inc/               # 头文件
│   └── Src/               # 源文件 (main.c)
├── sysFunction/           # 系统功能模块
├── Drivers/               # STM32 HAL 驱动
├── Middlewares/           # 中间件 (FatFs, LittleFS 等)
├── Components/            # 外设驱动组件
├── MDK-ARM/              # Keil 工程文件
└── README.md
```

## 使用说明

1. **系统上电**: 自动初始化所有外设，OLED 显示 "system idle"
2. **时间配置**: 通过串口设置 RTC 基准时间
3. **参数设置**: 配置变比和告警阈值
4. **开始采集**: 串口命令或按键启动采样
5. **查看数据**: OLED 实时显示，TF 卡文件存储

## 注意事项

- 确保 TF 卡格式为 FAT32
- 串口参数: 115200 8N1
- 如无后备电池，断电后需重新设置 RTC
- 所有功能模块代码必须位于 `sysFunction/` 目录下

## 技术特性

- **实时性**: 基于 DMA 的高效数据采集
- **可靠性**: 多重错误检测与处理机制  
- **扩展性**: 模块化设计，易于功能扩展
- **存储管理**: 文件轮转机制，避免单文件过大
- **数据安全**: 支持数据加密存储

---
